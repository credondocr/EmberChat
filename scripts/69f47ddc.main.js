!function(){window.EmberChat=Ember.Application.create({LOG_TRANSITIONS:!0,server:{host:window.location.hostname,port:"8589",path:window.location.pathname+"emberchat/socket"}})}(),function(){EmberChat.Conversation=Ember.Object.extend({name:null,id:null,content:null,newMessages:0,room:null,user:null})}(),function(){EmberChat.Participant=Ember.Object.extend({name:null,id:null,newMessages:0})}(),function(){EmberChat.Room=EmberChat.Participant.extend({})}(),function(){EmberChat.User=EmberChat.Participant.extend({})}(),function(){EmberChat.AbstractMessage=Ember.Object.extend({process:function(){throw new Ember.Error("Process method needs do be implemented in "+this.constructor.toString())}})}(),function(){EmberChat.AbstractListMessage=EmberChat.AbstractMessage.extend({process:function(){var a=this.get("content");return Ember.assert(this.constructor.toString()+" contains no content!","object"==typeof a),Ember.assert(this.constructor.toString()+" needs a listContainer property","object"==typeof this.get("listContainer")),this.updateListContainer(a,this.get("listContainer")),!0},createListElement:function(){throw new Ember.Error("Method createListElement needs do be implemented in "+this.constructor.toString())},updateListContainer:function(a,b){for(var c=0;c<b.length;c++){var d=a.findBy("id",b[c].get("id"));d?(b[c].setProperties(d),a.removeObject(d)):b.removeObject(b[c])}this.createListElement(a,b)}})}(),function(){EmberChat.ConversationMessage=EmberChat.AbstractMessage.extend({process:function(){var a=this.getConversationObject();return a.get("isDisplayed")||this.doBackgroundTasks(a),this.fillConversationObject(a),!0},getConversationObject:function(){throw new Ember.Error("Method getConversationObject needs do be implemented in "+this.constructor.toString())},fillConversationObject:function(a){var b=this.get("content");Ember.assert("ConversationMessage contains no content!","object"==typeof b),a.get("content")?a.get("content").pushObjects(b):a.set("content",Ember.A(b))},doBackgroundTasks:function(a){a.set("newMessages",parseInt(a.get("newMessages"))+1)}})}(),function(){EmberChat.UserConversationMessage=EmberChat.ConversationMessage.extend({getConversationObject:function(){var a=EmberChat.Session.findUserById(this.get("user").id);Ember.assert("ConversationMessage: Could not get user by id "+this.get("user"),"object"==typeof a);var b=EmberChat.Session.findConversationById(a.get("id"));return b||(b=EmberChat.Conversation.create({id:a.get("id"),name:a.get("name"),user:a}),EmberChat.Session.get("conversations").pushObject(b)),b}})}(),function(){EmberChat.RoomConversationMessage=EmberChat.ConversationMessage.extend({getConversationObject:function(){var a=EmberChat.Session.findRoomById(this.get("room").id);Ember.assert("ConversationMessage: Could not get room by id "+this.get("room"),"object"==typeof a);var b=EmberChat.Session.findConversationById(a.get("id"));return b||(b=EmberChat.Conversation.create({id:a.get("id"),name:a.get("name"),room:a}),EmberChat.Session.get("conversations").pushObject(b)),b}})}(),function(){EmberChat.RoomJoinMessage=EmberChat.RoomConversationMessage.extend({process:function(){var a=this.getConversationObject();if(!a)return!1;var b=EmberChat.User.create(this.get("user")),c=EmberChat.Session.findUserById(b.get("id"));if(!c)return!1;var d=this.createContent(c);return a.get("content")?a.get("content").pushObjects(d):a.set("content",Ember.A(d)),!0},createContent:function(a){return[{info:!0,content:a.get("name")+" joined"}]}})}(),function(){EmberChat.RoomLeaveMessage=EmberChat.RoomJoinMessage.extend({createContent:function(a){return[{info:!0,content:a.get("name")+" left"}]}})}(),function(){EmberChat.RoomListMessage=EmberChat.AbstractListMessage.extend({listContainerBinding:"EmberChat.Session.availableRooms",createListElement:function(a,b){for(var c=0;c<a.length;c++)b.pushObject(EmberChat.User.create(a[c]))}})}(),function(){EmberChat.SettingsMessage=EmberChat.AbstractMessage.extend({process:function(){EmberChat.Session.get("user");return Ember.assert("Settings message contains no user data!",this.get("user")),EmberChat.Session.set("user",EmberChat.User.create(this.get("user"))),Ember.$(document).attr("title","EC: "+EmberChat.Session.get("user").get("name")),!0}})}(),function(){EmberChat.UserListMessage=EmberChat.AbstractListMessage.extend({listContainerBinding:"EmberChat.Session.availableUsers",createListElement:function(a,b){for(var c=0;c<a.length;c++)b.pushObject(EmberChat.Room.create(a[c]))}})}(),function(){EmberChat.MessageProcessor=Ember.Object.create({processIncoming:function(a){var b=JSON.parse(a.data);switch(b.type){case"Settings":return EmberChat.SettingsMessage.create(b).process();case"UserList":return EmberChat.UserListMessage.create(b).process();case"RoomList":return EmberChat.RoomListMessage.create(b).process();case"UserConversation":return EmberChat.UserConversationMessage.create(b).process();case"RoomConversation":return EmberChat.RoomConversationMessage.create(b).process();case"RoomJoin":return EmberChat.RoomJoinMessage.create(b).process();case"RoomLeave":return EmberChat.RoomLeaveMessage.create(b).process();default:return Ember.warn("Unknown message type: "+b.type),!1}},processOutgoing:function(a){"object"==typeof a&&EmberChat.Socket.sendMessage(JSON.stringify(a))}})}(),function(){EmberChat.Session=Ember.Object.create({user:EmberChat.User.create(),availableUsers:Ember.A(),availableRooms:Ember.A(),conversations:Ember.A(),findConversationById:function(a){return this.get("conversations").findBy("id",a)},findUserById:function(a){return this.get("availableUsers").findBy("id",a)},findRoomById:function(a){return this.get("availableRooms").findBy("id",a)},offlineTasks:function(){this.get("availableUsers").forEach(function(a){Ember.set(a,"online",!1)})}})}(),function(){EmberChat.Socket=Ember.Object.create({hostBinding:"EmberChat.server.host",portBinding:"EmberChat.server.port",pathBinding:"EmberChat.server.path",online:!1,socket:null,connect:function(){if("undefined"==typeof EmberChat.socketDisabled||EmberChat.socketDisabled!==!0){var a=this;if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void Ember.warn("Browser does not support WebSockets");var b=new WebSocket("ws://"+this.get("host")+":"+this.get("port")+this.get("path"));b.onopen=function(){a.onOpen()},b.onerror=function(c){b.close(),a.onError(c)},b.onclose=function(){a.onClose()},b.onmessage=function(b){a.onMessage(b)},this.set("socket",b)}},sendMessage:function(a){this.get("online")&&this.get("socket").send(a)},onOpen:function(){this.set("online",!0)},onError:function(a){Ember.warn("Socket error: "+a),console.dir(a),this.set("online",!1)},onClose:function(){this.set("online",!1),EmberChat.Session.offlineTasks()},onMessage:function(a){EmberChat.MessageProcessor.processIncoming(a)}})}(),function(){EmberChat.ApplicationController=Ember.ArrayController.extend({})}(),function(){EmberChat.ConversationController=Ember.Controller.extend({actions:{send:function(){var a={type:"message",content:this.get("text")};this.get("conversation").get("user")?a.user=this.get("conversation").get("id"):a.room=this.get("conversation").get("id"),EmberChat.MessageProcessor.processOutgoing(a),this.set("text","")},close:function(){if(this.transitionToRoute("index"),this.get("conversation").get("room")){var a={type:"RoomLeave",room:this.get("conversation").get("room").get("id")};EmberChat.MessageProcessor.processOutgoing(a)}EmberChat.Session.get("conversations").removeObject(this.get("conversation"))}}})}(),function(){EmberChat.ConversationRoomController=EmberChat.ConversationController.extend({})}(),function(){EmberChat.ConversationUserController=EmberChat.ConversationController.extend({})}(),function(){EmberChat.RoomsController=Ember.ArrayController.extend({})}(),function(){EmberChat.ApplicationAdapter=DS.FixtureAdapter}(),function(){EmberChat.ApplicationRoute=Ember.Route.extend({setupController:function(){Ember.run.later(this,function(){EmberChat.Socket.connect()},100)}})}(),function(){EmberChat.ConversationRoute=Ember.Route.extend({setupController:function(){},setupConversation:function(a){a.set("isDisplayed",!0),a.set("newMessages",0)},model:function(a){return"object"==typeof a&&a.id?EmberChat.Session.findConversationById(a.id):null},actions:{willTransition:function(){this.controller.get("conversation").set("isDisplayed",!1)}}})}(),function(){EmberChat.ConversationRoomRoute=EmberChat.ConversationRoute.extend({setupController:function(a,b){if(a.set("conversation",b),!b.get("content")){var c={type:"RoomJoin",room:b.get("room").get("id")};EmberChat.MessageProcessor.processOutgoing(c)}},model:function(a){var b=this._super(a);if(!b){var c=EmberChat.Session.findRoomById(a.id);if(console.log(c),!c)return this.transitionTo("index"),null;b=EmberChat.Conversation.create({id:a.id,name:c.get("name"),room:c}),EmberChat.Session.get("conversations").pushObject(b)}return this.setupConversation(b),this.controllerFor("conversation").set("conversation",b),b}})}(),function(){EmberChat.ConversationUserRoute=EmberChat.ConversationRoute.extend({setupController:function(a,b){if(a.set("conversation",b),!b.get("content")){var c=EmberChat.SettingsMessage.create({type:"requestHistory",user:b.get("user").get("id")});EmberChat.MessageProcessor.processOutgoing(c)}},model:function(a){var b=this._super(a);if(!b){var c=EmberChat.Session.findUserById(a.id);if(!c)return this.transitionTo("index"),null;b=EmberChat.Conversation.create({id:a.id,name:c.get("name"),user:c}),EmberChat.Session.get("conversations").pushObject(b)}return this.setupConversation(b),this.controllerFor("conversation").set("conversation",b),b}})}(),function(){EmberChat.IndexRoute=Ember.Route.extend({redirect:function(){this.transitionTo("rooms")}})}(),function(){EmberChat.RoomsRoute=Ember.Route.extend({model:function(){return EmberChat.Session.get("availableRooms")}})}(),function(){EmberChat.ConversationListComponent=Ember.Component.extend({conversationsBinding:"EmberChat.Session.conversations"})}(),function(){EmberChat.SessionInfoComponent=Ember.Component.extend({isOnlineBinding:"EmberChat.Socket.online",userBinding:"EmberChat.Session.user",actions:{connect:function(){EmberChat.Socket.connect()},disconnect:function(){EmberChat.Socket.get("socket").close(),EmberChat.Session.offlineTasks()}}})}(),function(){EmberChat.UserListComponent=Ember.Component.extend({usersBinding:"EmberChat.Session.availableUsers"})}(),function(){EmberChat.ConversationView=Ember.View.extend({classNames:["panel panel-default"],conversationChanged:function(){this.scrollContent()}.observes("controller.conversation.content.@each"),scrollContent:function(){var a=this;setTimeout(function(){var b=Ember.$(a.get("element")).find(".conversation-content");b&&b[0]&&b.animate({scrollTop:b[0].scrollHeight},"fast")},10)}})}(),function(){EmberChat.ConversationUserView=Ember.View.extend({})}(),function(){EmberChat.Router.map(function(){this.route("rooms"),this.resource("conversation",function(){this.route("user",{path:"user/:id"}),this.route("room",{path:"room/:id"})})})}();