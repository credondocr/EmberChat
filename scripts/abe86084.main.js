!function(){window.EmberChat=Ember.Application.create({LOG_TRANSITIONS:!0,server:{host:window.location.hostname,port:"8589",path:window.location.pathname+"socket"}})}(),function(){EmberChat.Conversation=Ember.Object.extend({name:null,id:null,newMessages:0})}(),function(){EmberChat.User=Ember.Object.extend({name:null,id:null,newMessages:0})}(),function(){EmberChat.AbstractMessage=Ember.Object.extend({process:function(){return Ember.warn("Process method needs do be implemented in "+this.constructor.toString()),!1}})}(),function(){EmberChat.ConversationMessage=EmberChat.AbstractMessage.extend({process:function(){var a=this.getConversationObject();return a.get("isDisplayed")||this.doBackgroundTasks(a),this.fillConversationObject(a),!0},getConversationObject:function(){var a=EmberChat.Session.findUserById(this.get("user").id);Ember.assert("ConversationMessage: Could not get user by id "+this.get("user"),"object"==typeof a);var b=EmberChat.Session.findConversationById(a.get("id"));return b||(b=EmberChat.Conversation.create({id:a.get("id"),name:a.get("name")}),EmberChat.Session.get("conversations").pushObject(b)),b},fillConversationObject:function(a){var b=this.get("content");Ember.assert("ConversationMessage contains no content!","object"==typeof b),a.get("content")?a.get("content").pushObjects(b):a.set("content",Ember.A(b))},doBackgroundTasks:function(a){a.set("newMessages",parseInt(a.get("newMessages"))+1)}})}(),function(){EmberChat.SettingsMessage=EmberChat.AbstractMessage.extend({process:function(){EmberChat.Session.get("user");return Ember.assert("Settings message contains no user data!",this.get("user")),EmberChat.Session.set("user",EmberChat.User.create(this.get("user"))),Ember.$(document).attr("title","EC: "+EmberChat.Session.get("user").get("name")),!0}})}(),function(){EmberChat.UserListMessage=EmberChat.AbstractMessage.extend({process:function(){var a=this.get("content");Ember.assert("UserList message contains no content!","object"==typeof a);for(var b=Ember.A(),c=0;c<a.length;c++)b.push(EmberChat.User.create(a[c]));return EmberChat.Session.set("availableUsers",b),!0}})}(),function(){EmberChat.MessageProcessor=Ember.Object.create({processIncoming:function(a){var b=JSON.parse(a.data);switch(b.type){case"Settings":return EmberChat.SettingsMessage.create(b).process();case"UserList":return EmberChat.UserListMessage.create(b).process();case"Conversation":return EmberChat.ConversationMessage.create(b).process();default:return Ember.warn("Unknown message type: "+b.type),!1}},processOutgoing:function(a){"object"==typeof a&&EmberChat.Socket.sendMessage(JSON.stringify(a))}})}(),function(){EmberChat.Session=Ember.Object.create({user:EmberChat.User.create(),availableUsers:Ember.A(),conversations:Ember.A(),findConversationById:function(a){for(var b=this.get("conversations"),c=0;c<b.length;c++)if(b.objectAt(c).get("id")===a)return b.objectAt(c);return null},findUserById:function(a){for(var b=this.get("availableUsers"),c=0;c<b.length;c++)if(b.objectAt(c).get("id")===a)return b.objectAt(c);return null},offlineTasks:function(){this.get("availableUsers").forEach(function(a){Ember.set(a,"online",!1)})}})}(),function(){EmberChat.Socket=Ember.Object.create({hostBinding:"EmberChat.server.host",portBinding:"EmberChat.server.port",pathBinding:"EmberChat.server.path",online:!1,socket:null,connect:function(){var a=this;if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void Ember.warn("Browser does not support WebSockets");var b=new WebSocket("ws://"+this.get("host")+":"+this.get("port")+this.get("path"));b.onopen=function(){a.onOpen()},b.onerror=function(c){b.close(),a.onError(c)},b.onclose=function(){a.onClose()},b.onmessage=function(b){a.onMessage(b)},this.set("socket",b)},sendMessage:function(a){this.get("socket").send(a)},onOpen:function(){this.set("online",!0)},onError:function(a){Ember.warn("Socket error: "+a),console.dir(a),this.set("online",!1)},onClose:function(){this.set("online",!1),EmberChat.Session.offlineTasks()},onMessage:function(a){EmberChat.MessageProcessor.processIncoming(a)}})}(),function(){EmberChat.ApplicationController=Ember.ArrayController.extend({})}(),function(){EmberChat.ConversationController=Ember.Controller.extend({actions:{send:function(){EmberChat.MessageProcessor.processOutgoing({type:"message",user:this.get("conversation").get("id"),content:this.get("text")}),this.set("text","")},close:function(){this.transitionToRoute("index"),EmberChat.Session.get("conversations").removeObject(this.get("conversation"))}}})}(),function(){EmberChat.ConversationUserController=EmberChat.ConversationController.extend({})}(),function(){EmberChat.ApplicationAdapter=DS.FixtureAdapter}(),function(){EmberChat.ApplicationRoute=Ember.Route.extend({setupController:function(){EmberChat.Socket.connect()}})}(),function(){EmberChat.ConversationUserRoute=Ember.Route.extend({setupController:function(a,b){b.set("isDisplayed",!0),b.set("newMessages",0),a.set("conversation",b)},model:function(a){return"object"==typeof a&&a.id?EmberChat.Session.findConversationById(a.id):(this.transitionTo("index"),null)},actions:{willTransition:function(){this.controller.get("conversation").set("isDisplayed",!1)}}})}(),function(){EmberChat.ConversationUserRoute=EmberChat.ConversationUserRoute.extend({setupController:function(a,b){if(this._super(a,b),!b.get("content")){var c=EmberChat.SettingsMessage.create({type:"requestHistory",user:b.get("user").get("id")});EmberChat.MessageProcessor.processOutgoing(c)}},model:function(a){var b=this._super(a);if(!b){var c=EmberChat.Session.findUserById(a.id);if(!c)return this.transitionTo("index"),null;b=EmberChat.Conversation.create({id:a.id,name:c.get("name"),user:c}),EmberChat.Session.get("conversations").pushObject(b)}return this.controllerFor("conversation").set("conversation",b),b}})}(),function(){EmberChat.ConversationListComponent=Ember.Component.extend({conversationsBinding:"EmberChat.Session.conversations"})}(),function(){EmberChat.SessionInfoComponent=Ember.Component.extend({isOnlineBinding:"EmberChat.Socket.online",userBinding:"EmberChat.Session.user",actions:{connect:function(){EmberChat.Socket.connect()},disconnect:function(){EmberChat.Socket.get("socket").close(),EmberChat.Session.offlineTasks()}}})}(),function(){EmberChat.UserListComponent=Ember.Component.extend({usersBinding:"EmberChat.Session.availableUsers"})}(),function(){EmberChat.ConversationView=Ember.View.extend({classNames:["panel panel-default"],conversationChanged:function(){this.scrollContent()}.observes("controller.conversation.content.@each"),scrollContent:function(){var a=this;setTimeout(function(){var b=Ember.$(a.get("element")).find(".conversation-content");b&&b[0]&&b.animate({scrollTop:b[0].scrollHeight},"fast")},10)}})}(),function(){EmberChat.ConversationUserView=Ember.View.extend({})}(),function(){EmberChat.Router.map(function(){this.resource("conversation",function(){this.route("user",{path:"user/:id"})})})}();